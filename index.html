<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clinician DTR - User Panel (Snake & Ladder)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg1:#fff7fb; --bg2:#f3e8ff; --accent:#7c3aed; --muted:#6b7280;
      --card-bg: rgba(255,255,255,0.18);
    }
    html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial,sans-serif; background:linear-gradient(180deg,var(--bg1),#ffd6ed); color:#2c0a34;}
    .wrap{max-width:1024px;margin:18px auto;padding:18px;box-sizing:border-box;}
    .card{background:var(--card-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.35);box-shadow:0 8px 22px rgba(12,12,20,0.06);margin-bottom:12px;}
    h1{margin:0 0 8px;font-size:20px}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.35);background:rgba(255,255,255,0.12);color:#2c0a34;margin:6px 0}
    button{cursor:pointer;border:none;padding:8px 12px;border-radius:10px;background:linear-gradient(135deg,#fff,#ffd6fb,#c4b5fd);font-weight:600}
    .linkbtn{background:transparent;border:none;text-decoration:underline;cursor:pointer;color:#2c0a34}
    .muted{color:var(--muted);font-size:13px}
    .small{padding:8px 10px;border-radius:8px}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    .toggle-btns{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}
    .toggle-btns button{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px 12px;border-radius:10px}
    .toggle-btns button.active{background:var(--accent);color:white}
    /* Game lobby layout */
    .game-lobby{display:flex;gap:14px;flex-wrap:wrap}
    .lobby-left{flex:0 0 360px;min-width:280px}
    .lobby-right{flex:1;min-width:220px}
    .room-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.04);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;border:1px solid rgba(0,0,0,0.04)}
    .room-code{font-weight:700;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.06)}
    .muted-small{font-size:12px;color:var(--muted)}
    .floating-controls{position:relative}
    /* top-right compact icons container (hidden until inside a room) */
    .top-right-controls{position:fixed; top:16px; right:18px; display:flex; gap:8px; z-index:9999;}
    .tr-btn{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.14);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.08); cursor:pointer; border:1px solid rgba(0,0,0,0.04)}
    .tr-btn:hover{transform:translateY(-2px)}
    .hidden{display:none}
    .chat{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)}
    .chat-line{padding:6px;border-radius:6px;margin-bottom:6px;background:rgba(0,0,0,0.03)}
    .log{max-height:140px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)}
    footer.page-footer{ text-align:center;width:100%;padding:10px 0;font-size:13px;color:#5a437c;opacity:0.85;margin-top:18px }
    @media(max-width:860px){ .game-lobby{flex-direction:column} .lobby-left{flex-basis:100%} .lobby-right{flex-basis:100%} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- AUTH (kept) -->
    <div class="card" id="authArea">
      <h1>Login</h1>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p class="muted">Don‚Äôt have an account?
        <button class="linkbtn" onclick="toggleAuth('register')">Create one</button>
      </p>
      <p><button class="linkbtn" onclick="showForgotPassword()">Forgot Password?</button></p>
      <p id="authMsg" class="muted"></p>
    </div>

    <div class="card" id="forgotArea" style="display:none">
      <h1>Reset Password</h1>
      <input type="email" id="resetEmail" placeholder="Enter your registered email" />
      <button onclick="resetPassword()">Send Reset Link</button>
      <p class="muted"><button class="linkbtn" onclick="toggleAuth('login')">Back to Login</button></p>
      <p id="resetMsg" class="muted"></p>
    </div>

    <div class="card" id="registerArea" style="display:none">
      <h1>Create Account</h1>
      <input type="text" id="regName" placeholder="Full Name" />
      <input type="email" id="regEmail" placeholder="Email" />
      <input type="password" id="regPassword" placeholder="Password" />
      <input type="text" id="regLevel" placeholder="Clinical Level" />
      <button onclick="register()">Register</button>
      <p class="muted">Already have an account?
        <button class="linkbtn" onclick="toggleAuth('login')">Login</button>
      </p>
      <p id="regMsg" class="muted"></p>
    </div>

    <!-- USER PANEL -->
    <div class="card" id="userPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>DMD CLINICIAN DTR</h1>
        <div>
          <button id="settingsBtn" style="padding:6px 10px;font-size:13px;">‚öôÔ∏è Update Info</button>
        </div>
      </div>

      <div class="muted">Signed in as</div>
      <div id="nameDisplay" style="font-weight:600"></div>
      <div id="emailDisplay" class="muted"></div>
      <div id="levelDisplay" class="muted"></div>

      <div id="qr" style="margin:8px 0"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="logoutBtn" style="background:#ef4444;color:white;">Logout</button>
      </div>

      <div class="toggle-btns">
        <button id="dtrBtn" class="active">My DTR Records</button>
        <button id="caseBtn">My Case Selections</button>
        <button id="gameBtn">üé≤ Snake & Ladder</button>
      </div>

      <div id="dtrSection">
        <h3>My DTR Records</h3>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Date</th><th style="text-align:left">Time In</th></tr></thead>
          <tbody id="myDtrBody"><tr><td colspan="2" class="muted">No records</td></tr></tbody>
        </table>
      </div>

      <div id="caseSection" style="display:none">
        <h3>My Case Selections</h3>
        <input type="text" id="caseSearch" class="search-box" placeholder="Search cases..." />
        <button id="openCaseModal" style="margin:6px 0" disabled title="Please Time In first">‚ûï New Case Selection</button>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th>Type</th><th>Details</th><th>Date</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="caseBody"><tr><td colspan="5" class="muted">No cases</td></tr></tbody>
        </table>
      </div>

      <!-- SNAKE & LADDER LOBBY -->
      <div id="gameSection" style="display:none">
        <h3>üé≤ Snake & Ladder</h3>
        <div class="card game-lobby">
          <div class="lobby-left">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="roomInput" placeholder="Enter room code (or leave blank to create)" />
              <div style="display:flex;gap:6px">
                <button id="createRoomBtn" onclick="createRoom()">Create</button>
                <button id="joinRoomBtn" onclick="joinRoom()">Join</button>
              </div>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px; align-items:center">
              <div class="muted-small">Room:</div>
              <div id="currentRoom" class="room-code">‚Äî</div>
              <div style="margin-left:auto" class="muted-small">Players: <span id="playerCount">0</span>/6</div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
              <strong>Players</strong>
              <div>
                <button id="startBtn" onclick="startMatch()" disabled>Start</button>
                <button id="leaveBtn" onclick="leaveRoom()" style="background:#ef4444;color:white">Leave</button>
              </div>
            </div>

            <div id="playersContainer" style="margin-top:8px"></div>

            <div style="margin-top:12px">
              <strong>Room Log</strong>
              <div id="roomLog" class="log" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="lobby-right">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>General Chat (Lobby)</strong>
              <div class="muted-small">All players here</div>
            </div>
            <div id="generalChat" class="chat" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="generalChatInput" placeholder="Say something to everyone..." />
              <button onclick="sendGeneralChat()">Send</button>
            </div>

            <div style="margin-top:12px">
              <strong>Active Rooms</strong>
              <div id="roomsList" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- userPanel -->
  </div> <!-- wrap -->

  <!-- top-right control icons (hidden by default) -->
  <div id="topRightControls" class="top-right-controls hidden">
    <div id="btnShowBoard" class="tr-btn" title="Show Board" onclick="toggleBoard()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c0a34" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
    </div>
    <div id="btnShowChat" class="tr-btn" title="Show Chat" onclick="toggleRoomChat()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c0a34" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </div>
    <div id="btnShowDice" class="tr-btn" title="Show Dice" onclick="toggleDicePanel()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c0a34" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    </div>
  </div>

  <!-- Popup containers (board/dice will be in Part 2) -->
  <div id="roomBoardPopup" class="card hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9998;max-width:92vw;max-height:90vh;overflow:auto"></div>
  <div id="roomChatPopup" class="card hidden" style="position:fixed;right:18px;top:80px;z-index:9998;width:320px;max-height:70vh;overflow:auto"></div>
  <div id="dicePopup" class="card hidden" style="position:fixed;right:18px;top:160px;z-index:9998;width:220px"></div>

  <!-- KEEP existing modals (settings, case); simplified -->
  <div id="settingsModal" style="display:none"></div>

  <!-- SCRIPTS PART 1 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
  /* ===== FIREBASE CONFIG ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  /* ===== UI helper functions (kept) ===== */
  function toggleAuth(mode){ document.getElementById("authArea").style.display = (mode==='register') ? 'none' : 'block'; document.getElementById("registerArea").style.display = (mode==='register') ? 'block' : 'none'; document.getElementById("forgotArea").style.display='none'; }
  function showForgotPassword(){ document.getElementById('authArea').style.display='none'; document.getElementById('registerArea').style.display='none'; document.getElementById('forgotArea').style.display='block'; }
  async function resetPassword(){ const email=document.getElementById('resetEmail').value.trim(); const msg=document.getElementById('resetMsg'); if(!email){ msg.textContent='Please enter your email.'; msg.className='error'; return;} try{ await auth.sendPasswordResetEmail(email); msg.textContent='‚úÖ Password reset link sent!'; msg.className='success'; }catch(e){ msg.textContent=e.message; msg.className='error'; } }

  /* ===== AUTH ===== */
  async function login(){ const email=document.getElementById('email').value; const pass=document.getElementById('password').value; const msg=document.getElementById('authMsg'); try{ await auth.signInWithEmailAndPassword(email, pass); } catch(e){ msg.textContent = e.message; msg.className = 'muted error'; } }
  async function register(){ const name=document.getElementById('regName').value.trim(); const email=document.getElementById('regEmail').value.trim(); const pass=document.getElementById('regPassword').value; const level=document.getElementById('regLevel').value.trim(); const msg=document.getElementById('regMsg'); try{ const cred = await auth.createUserWithEmailAndPassword(email, pass); const uid = cred.user.uid; await db.ref('users/' + uid + '/profile').set({ name, email, clinicalLevel: level }); msg.textContent = 'Account created!'; msg.className='success'; await auth.signInWithEmailAndPassword(email, pass); } catch(e){ msg.textContent = e.message; msg.className='error'; } }
  document.getElementById('logoutBtn').onclick = () => { attemptLeaveRoom(); auth.signOut(); };

  /* ===== LOAD DTR & CASES (kept minimal) ===== */
  async function loadUserDTR(uid){ const tbody=document.getElementById('myDtrBody'); const snap=await db.ref('users/'+uid+'/dtr').get(); tbody.innerHTML=''; if(!snap.exists()){ tbody.innerHTML="<tr><td colspan='2' class='muted'>No records</td></tr>"; return;} snap.forEach(child=>{ const date=child.key; const rec=child.val(); tbody.innerHTML+=`<tr><td>${date}</td><td>${rec.timeIn||'-'}</td></tr>`; }); }
  async function loadUserCases(uid){
    const tbody=document.getElementById('caseBody'); tbody.innerHTML="<tr><td colspan='5' class='muted'>Loading cases...</td></tr>";
    if(window.userCasesListener) db.ref('userCases/'+uid).off('value', window.userCasesListener);
    window.userCasesListener = db.ref('userCases/'+uid).on('value', snap=>{ tbody.innerHTML=''; if(!snap.exists()){ tbody.innerHTML="<tr><td colspan='5' class='muted'>No cases</td></tr>"; return;} snap.forEach(child=>{ const cid=child.key; const c=child.val()||{}; const date=c.timestamp?new Date(c.timestamp).toLocaleString():'-'; const status = c.status==='completed'?`<span class='status-badge completed'>‚úÖ Completed</span>`:`<span class='status-badge pending'>Pending</span>`; const action = c.status==='completed'?'‚Äî':`<button onclick="markCaseComplete('${uid}','${cid}', event)">Mark Completed</button>`; tbody.innerHTML+=`<tr id="case-${cid}"><td>${c.type||'-'}</td><td>${c.details||''}<br><span class='muted'>Instructor: ${c.instructor||"Pending"}</span></td><td>${date}</td><td>${status}</td><td>${action}</td></tr>`; }); applyCaseSearch(); });
  }
  function applyCaseSearch(){ const input=document.getElementById('caseSearch').value.toLowerCase(); const rows=document.querySelectorAll("#caseBody tr"); rows.forEach(row=>{ const text=row.innerText.toLowerCase(); row.style.display = text.includes(input)?'':'none'; }); }
  document.getElementById('caseSearch').addEventListener('input', applyCaseSearch);

  let markInProgress=false;
  async function markCaseComplete(uid,cid,event){ if(markInProgress) return; markInProgress=true; try{ const btn=event?.target; if(btn){ btn.disabled=true; btn.innerText="‚è≥"; } const caseRef=db.ref(`userCases/${uid}/${cid}`); const caseSnap=await caseRef.get(); if(!caseSnap.exists()){ showToast("‚ö†Ô∏è Case not found"); return; } await caseRef.update({ status:"completed", completedAt: Date.now() }); showToast("‚úÖ Case marked completed"); }catch(e){ console.error(e); showToast("‚ùå Failed"); } finally{ const btn=event?.target; if(btn){ btn.disabled=false; btn.innerText="Mark Completed"; } markInProgress=false; } }

  /* ===== AUTH STATE HANDLING ===== */
  auth.onAuthStateChanged(async user=>{
    if(user){
      document.getElementById('authArea').style.display='none'; document.getElementById('registerArea').style.display='none'; document.getElementById('forgotArea').style.display='none'; document.getElementById('userPanel').style.display='block';
      const profileSnap = await db.ref('users/' + user.uid + '/profile').get(); const profile = profileSnap.exists()?profileSnap.val():{};
      document.getElementById('nameDisplay').textContent = profile.name || user.email;
      document.getElementById('emailDisplay').textContent = profile.email || '';
      document.getElementById('levelDisplay').textContent = profile.clinicalLevel?`Clinical Level: ${profile.clinicalLevel}`:'';
      document.getElementById('lpClinician')?.setAttribute('value', profile.name || user.email);
      document.getElementById('qr').innerHTML = '';
      new QRCode(document.getElementById('qr'), { text: user.uid, width:140, height:140 });

      window.currentUser = { uid: user.uid, email: user.email, name: profile.name || user.email };
      loadUserDTR(user.uid); loadUserCases(user.uid);
      // auto-join if listed in a room
      setTimeout(tryAutoRejoin, 1200);
      // populate lobby rooms & general chat
      subscribeRoomsList();
      subscribeGeneralChat();
    } else {
      document.getElementById('authArea').style.display='block'; document.getElementById('registerArea').style.display='none'; document.getElementById('forgotArea').style.display='none'; document.getElementById('userPanel').style.display='none';
      window.currentUser = null;
      unsubscribeRoomsList();
      unsubscribeGeneralChat();
      attemptLeaveRoom();
    }
  });

  /* ===== TOP-RIGHT BUTTONS CONTROL (only shown inside room) ===== */
  function showTopRightControls(show){
    const el = document.getElementById('topRightControls');
    if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
  }
  function toggleBoard(){ // Part 2 will fill this in
    const el = document.getElementById('roomBoardPopup');
    el.classList.toggle('hidden');
  }
  function toggleRoomChat(){
    const el = document.getElementById('roomChatPopup');
    el.classList.toggle('hidden');
  }
  function toggleDicePanel(){
    const el = document.getElementById('dicePopup');
    el.classList.toggle('hidden');
  }

  /* ===== ROOM / LOBBY LOGIC (PART 1) ===== */
  const MAX_PLAYERS = 6;
  const MIN_PLAYERS = 2; // minimum to start
  window.currentRoom = null;
  window.roomListenerOff = null;
  window.roomsListListener = null;
  window.generalChatListener = null;

  function genRoomCode(){
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
    let s = '';
    for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

    // create a new room
  async function createRoom(){
    if(!window.currentUser) return alert('Please login first');
    const code = genRoomCode();
    const ref = db.ref('snakeRooms/' + code);
    const snap = await ref.get();
    if(snap.exists()) return createRoom(); // collision
    const player = {
      id: window.currentUser.uid,
      name: window.currentUser.name || window.currentUser.email,
      pos: 1, // starting square 1
      joinedAt: Date.now(),
      online: true,
      tokenIndex: 0
    };
    const roomObj = {
      owner: window.currentUser.uid,
      createdAt: Date.now(),
      players: { [window.currentUser.uid]: player },
      turnOrder: [window.currentUser.uid],
      currentTurn: 0,
      started: false,
      chat: {},
      heartbeat: Date.now()
    };
    await ref.set(roomObj);
    joinRoomByCode(code, true);
  }

  // join room: uses input field
  async function joinRoom(){
    if(!window.currentUser) return alert('Please login');
    const code = (document.getElementById('roomInput').value || '').trim().toUpperCase();
    if(!code) return alert('Enter room code or create a room');
    const ref = db.ref('snakeRooms/' + code);
    const snap = await ref.get();
    if(!snap.exists()) return alert('Room not found');
    const room = snap.val();
    const players = room.players || {};
    if(Object.keys(players).length >= MAX_PLAYERS) return alert('Room full (max 6)');
    // if already present, just attach
    if(players[window.currentUser.uid]){
      joinRoomByCode(code, false);
      return;
    }
    // assign token index
    const idx = Object.keys(players).length % 6;
    const player = {
      id: window.currentUser.uid,
      name: window.currentUser.name || window.currentUser.email,
      pos: 1,
      joinedAt: Date.now(),
      online: true,
      tokenIndex: idx
    };
    await ref.child('players/' + window.currentUser.uid).set(player);
    const order = room.turnOrder || []; if(!order.includes(window.currentUser.uid)) order.push(window.currentUser.uid);
    await ref.child('turnOrder').set(order);
    joinRoomByCode(code, false);
  }

  // generic join helper
  async function joinRoomByCode(code, justCreated){
    // detach previous listener if any
    if(window.roomListenerOff) window.roomListenerOff();
    window.currentRoom = code;
    document.getElementById('currentRoom').textContent = code;
    showTopRightControls(true);
    subscribeRoom(code);
    markPresence(code, true);
    logRoom(`Joined room: ${code}`);
    document.getElementById('roomInput').value = code;
  }

  // subscribe to a specific room for real-time updates
  function subscribeRoom(code){
    const rRef = db.ref('snakeRooms/' + code);
    const cb = rRef.on('value', snap=>{
      if(!snap.exists()){
        // room removed/closed
        logRoom('Room closed');
        attemptLeaveRoom(true);
        return;
      }
      const room = snap.val();
      renderRoom(room, code);
      // keep heartbeat timestamp updated
      rRef.child('heartbeat').set(Date.now());
    }, err=>{
      console.error('room listen error', err);
    });
    window.roomListenerOff = () => rRef.off('value', cb);
  }

  // render room UI in lobby (players list, start button state)
  function renderRoom(room, code){
    if(!room) return;
    const players = room.players || {};
    // render players container
    const pc = document.getElementById('playersContainer'); pc.innerHTML = '';
    // order by turnOrder
    const order = room.turnOrder || Object.keys(players);
    order.forEach(pid=>{
      const p = players[pid];
      if(!p) return;
      const div = document.createElement('div');
      div.className = 'room-item';
      div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-weight:700">${(p.tokenIndex||0)+1}</div><div><strong>${p.name}</strong><div class="muted-small">${p.online ? 'Online' : 'Offline'}</div></div></div><div style="text-align:right"><div class="muted-small">Pos: ${p.pos || 1}</div><div class="muted-small">Joined: ${new Date(p.joinedAt).toLocaleTimeString()}</div></div>`;
      if(window.currentUser && window.currentUser.uid === pid) div.classList.add('you');
      pc.appendChild(div);
    });
    document.getElementById('playerCount').textContent = Object.keys(players).length;
    // start button enabled only if owner and >= MIN_PLAYERS and not started
    const startBtn = document.getElementById('startBtn');
    if(window.currentUser && room.owner === window.currentUser.uid && !room.started && Object.keys(players).length >= MIN_PLAYERS) startBtn.disabled = false; else startBtn.disabled = true;
    // update log if _lastLog exists
    if(room._lastLog && room._lastLog !== window._lastLogSeen){ logRoom(room._lastLog); window._lastLogSeen = room._lastLog; }
    // show/hide top-right controls only if in room
    if(window.currentRoom === code) showTopRightControls(true); else showTopRightControls(false);
  }

  // start match (owner)
  async function startMatch(){
    if(!window.currentRoom) return alert('Join a room first');
    const rRef = db.ref('snakeRooms/' + window.currentRoom);
    const snap = await rRef.get();
    if(!snap.exists()) return alert('Room missing');
    const room = snap.val();
    if(room.owner !== window.currentUser.uid) return alert('Only owner can start');
    const players = room.players || {};
    if(Object.keys(players).length < MIN_PLAYERS) return alert('Need at least ' + MIN_PLAYERS + ' players to start');
    await rRef.update({ started: true, currentTurn: 0, _lastLog: 'Game started' });
    logRoom('Match started');
  }

  // presence: mark online and set onDisconnect
  function markPresence(roomCode, online){
    if(!window.currentUser || !roomCode) return;
    const pRef = db.ref(`snakeRooms/${roomCode}/players/${window.currentUser.uid}`);
    pRef.update({ online: online, lastSeen: Date.now() });
    pRef.onDisconnect().update({ online: false, lastSeen: Date.now() });
  }

  // leave room (user requested)
  async function leaveRoom(){
    // wrap to avoid accidental calls
    await attemptLeaveRoom(false);
  }
  async function attemptLeaveRoom(force){
    try{
      const code = window.currentRoom;
      if(!code) return;
      const roomRef = db.ref('snakeRooms/' + code);
      if(window.currentUser){
        // mark offline and remove player
        await roomRef.child('players/' + window.currentUser.uid).remove();
        // remove from turnOrder
        const tSnap = await roomRef.child('turnOrder').get();
        if(tSnap.exists()){
          const arr = tSnap.val().filter(id=> id !== window.currentUser.uid);
          await roomRef.child('turnOrder').set(arr);
        }
      }
      // if owner left, transfer ownership or delete
      const ownerSnap = await roomRef.child('owner').get();
      if(ownerSnap.exists()){
        const ownerId = ownerSnap.val();
        if(ownerId === (window.currentUser && window.currentUser.uid)){
          const playersSnap = await roomRef.child('players').get();
          if(playersSnap.exists()){
            const keys = Object.keys(playersSnap.val());
            if(keys.length > 0) await roomRef.child('owner').set(keys[0]); else await roomRef.remove();
          } else {
            await roomRef.remove();
          }
        }
      }
      // detach listener
      if(window.roomListenerOff){ window.roomListenerOff(); window.roomListenerOff = null; }
      window.currentRoom = null;
      document.getElementById('currentRoom').textContent = '‚Äî';
      document.getElementById('playersContainer').innerHTML = '';
      document.getElementById('roomLog').innerHTML = '';
      document.getElementById('playerCount').textContent = '0';
      showTopRightControls(false);
    }catch(e){
      console.error('leave error', e);
    }
  }

  /* ===== LOBBY ROOMS LIST & GENERAL CHAT ===== */
  function subscribeRoomsList(){
    const listRef = db.ref('snakeRooms');
    const cb = listRef.on('value', snap=>{
      const container = document.getElementById('roomsList');
      container.innerHTML = '';
      if(!snap.exists()){ container.innerHTML = '<div class="muted-small">No active rooms</div>'; return; }
      const rooms = snap.val();
      Object.keys(rooms).sort().forEach(code=>{
        const r = rooms[code];
        const players = r.players ? Object.keys(r.players).length : 0;
        const div = document.createElement('div'); div.className='room-item';
        div.innerHTML = `<div><strong>${code}</strong><div class="muted-small">${players} player(s)</div></div><div style="display:flex;gap:8px"><button onclick="quickJoin('${code}')">Join</button></div>`;
        container.appendChild(div);
      });
    });
    window.roomsListListener = () => listRef.off('value', cb);
  }
  function unsubscribeRoomsList(){ if(window.roomsListListener){ window.roomsListListener(); window.roomsListListener = null; } }

  function quickJoin(code){ document.getElementById('roomInput').value = code; joinRoom(); }

  // General Lobby Chat
  function subscribeGeneralChat(){
    const chatRef = db.ref('snakeLobbyChat');
    const cb = chatRef.on('value', snap=>{
      const box = document.getElementById('generalChat');
      box.innerHTML = '';
      if(!snap.exists()) return;
      const arr = Object.keys(snap.val()).map(k=> ({ id:k, ...snap.val()[k] })).sort((a,b)=> b.ts - a.ts);
      arr.forEach(c=>{
        const d = document.createElement('div'); d.className='chat-line'; d.innerHTML = `<strong>${c.name}</strong> <div class="muted-small">${new Date(c.ts).toLocaleTimeString()}</div><div style="margin-top:6px">${c.text}</div>`; box.appendChild(d);
      });
    });
    window.generalChatListener = () => chatRef.off('value', cb);
  }
  function unsubscribeGeneralChat(){ if(window.generalChatListener){ window.generalChatListener(); window.generalChatListener = null; } }

  async function sendGeneralChat(){
    if(!window.currentUser) return alert('Login to chat');
    const text = (document.getElementById('generalChatInput').value || '').trim();
    if(!text) return;
    const chatRef = db.ref('snakeLobbyChat').push();
    await chatRef.set({ uid: window.currentUser.uid, name: window.currentUser.name, text, ts: Date.now() });
    document.getElementById('generalChatInput').value = '';
  }

  /* ===== Room-specific CHAT (room chat & render) ===== */
  async function sendRoomChat(text){
    if(!window.currentRoom || !window.currentUser) return;
    const chatRef = db.ref(`snakeRooms/${window.currentRoom}/chat`).push();
    await chatRef.set({ uid: window.currentUser.uid, name: window.currentUser.name, text, ts: Date.now() });
  }
  function subscribeRoomChat(roomCode){
    const chatRef = db.ref(`snakeRooms/${roomCode}/chat`);
    const cb = chatRef.on('value', snap=>{
      const box = document.getElementById('roomChatPopup');
      box.innerHTML = '<div style="padding:8px"><strong>Room Chat</strong></div>';
      if(!snap.exists()){
        box.innerHTML += '<div class="muted-small" style="padding:8px">No messages</div>'; return;
      }
      const arr = Object.keys(snap.val()).map(k=> ({ id:k, ...snap.val()[k] })).sort((a,b)=> b.ts - a.ts);
      arr.forEach(c=>{
        const d = document.createElement('div'); d.className='chat-line'; d.innerHTML = `<strong>${c.name}</strong> <div class="muted-small">${new Date(c.ts).toLocaleTimeString()}</div><div style="margin-top:6px">${c.text}</div>`; box.appendChild(d);
      });
      // add input at bottom
      const inputWrap = document.createElement('div'); inputWrap.style.padding='8px'; inputWrap.innerHTML = `<div style="display:flex;gap:8px"><input id="roomChatInput" placeholder="Message..." style="flex:1"/><button onclick="roomChatSendFromPopup()">Send</button></div>`; box.appendChild(inputWrap);
    });
    // return unsubscribe
    return () => chatRef.off('value', cb);
  }
  function roomChatSendFromPopup(){ const v = (document.getElementById('roomChatInput') || {}).value || ''; if(v.trim()) sendRoomChat(v.trim()); (document.getElementById('roomChatInput') || {}).value = ''; }

  /* ===== tryAutoRejoin: if user already in some room, rejoin automatically ===== */
  async function tryAutoRejoin(){
    if(!window.currentUser) return;
    const roomsSnap = await db.ref('snakeRooms').get();
    if(!roomsSnap.exists()) return;
    const uid = window.currentUser.uid;
    let found = null;
    roomsSnap.forEach(rs=>{
      const r = rs.val();
      if(r.players && r.players[uid]) found = rs.key;
    });
    if(found){
      document.getElementById('roomInput').value = found;
      joinRoomByCode(found, false);
    }
  }

  /* ===== render and logging helpers ===== */
  function logRoom(msg){
    const el = document.getElementById('roomLog');
    const d = document.createElement('div'); d.textContent = `${new Date().toLocaleTimeString()} ‚Äî ${msg}`; el.prepend(d);
  }

  /* ===== subscribe general & rooms on load if logged in ===== */
  function subscribeRoomsList(){ if(!window.roomsListListener) { const rref = db.ref('snakeRooms'); const cb = rref.on('value', snap=>{ const container=document.getElementById('roomsList'); container.innerHTML=''; if(!snap.exists()){ container.innerHTML='<div class="muted-small">No active rooms</div>'; return; } const rooms = snap.val(); Object.keys(rooms).forEach(code=>{ const r=rooms[code]; const players = r.players ? Object.keys(r.players).length : 0; const div=document.createElement('div'); div.className='room-item'; div.innerHTML = `<div><strong>${code}</strong><div class="muted-small">${players} player(s)</div></div><div style="display:flex;gap:6px"><button onclick="quickJoin('${code}')">Join</button></div>`; container.appendChild(div); }); }); window.roomsListListener = ()=> rref.off('value', cb); } }
  function unsubscribeRoomsList(){ if(window.roomsListListener){ window.roomsListListener(); window.roomsListListener = null; } }
  // reuse earlier subscribeGeneralChat/unsubscribeGeneralChat

  /* ===== small UI wiring for tab switching (kept) ===== */
  const dtrBtn=document.getElementById('dtrBtn'); const caseBtn=document.getElementById('caseBtn'); const gameBtn=document.getElementById('gameBtn');
  dtrBtn.onclick = ()=> { dtrBtn.classList.add('active'); caseBtn.classList.remove('active'); gameBtn.classList.remove('active'); document.getElementById('dtrSection').style.display='block'; document.getElementById('caseSection').style.display='none'; document.getElementById('gameSection').style.display='none'; };
  caseBtn.onclick = ()=> { caseBtn.classList.add('active'); dtrBtn.classList.remove('active'); gameBtn.classList.remove('active'); document.getElementById('caseSection').style.display='block'; document.getElementById('dtrSection').style.display='none'; document.getElementById('gameSection').style.display='none'; };
  gameBtn.onclick = ()=> { gameBtn.classList.add('active'); dtrBtn.classList.remove('active'); caseBtn.classList.remove('active'); document.getElementById('gameSection').style.display='block'; document.getElementById('dtrSection').style.display='none'; document.getElementById('caseSection').style.display='none'; subscribeRoomsList(); subscribeGeneralChat(); };

  /* ===== simple cleanup: remove empty rooms older than 5 minutes ===== */
  setInterval(async ()=>{
    try{
      const snap = await db.ref('snakeRooms').get();
      if(!snap.exists()) return;
      const now = Date.now();
      snap.forEach(r=>{
        const room = r.val(); const key = r.key; const players = room.players ? Object.keys(room.players).length : 0;
        const last = room.heartbeat || room.lastActionAt || room.createdAt || 0;
        if(players === 0 && (now - last > 1000 * 60 * 5)) db.ref('snakeRooms/' + key).remove().catch(()=>{});
      });
    }catch(e){}
  }, 60 * 1000);

  /* ===== helper show/hide for room chat subscription when room popup opens (Part 2 will hook it too) ===== */
  let roomChatUnsub = null;
  function openRoomChatPopup(){
    if(!window.currentRoom) return alert('Join a room first');
    const popup = document.getElementById('roomChatPopup');
    popup.classList.remove('hidden');
    if(roomChatUnsub) roomChatUnsub();
    roomChatUnsub = subscribeRoomChat(window.currentRoom);
  }
  function closeRoomChatPopup(){
    const popup = document.getElementById('roomChatPopup'); popup.classList.add('hidden');
    if(roomChatUnsub){ roomChatUnsub(); roomChatUnsub = null; }
  }

  // small helpers to call toggles from top-right icons
  function toggleRoomChat(){ const popup = document.getElementById('roomChatPopup'); if(popup.classList.contains('hidden')) openRoomChatPopup(); else closeRoomChatPopup(); }
  function toggleBoard(){ // Part 2: will toggle board popup content
    const popup = document.getElementById('roomBoardPopup'); popup.classList.toggle('hidden');
  }
  function toggleDicePanel(){ const popup = document.getElementById('dicePopup'); popup.classList.toggle('hidden'); }

  // hookup general chat input enter key
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && document.activeElement && document.activeElement.id === 'generalChatInput'){ e.preventDefault(); sendGeneralChat(); }
    if(e.key === 'Enter' && document.activeElement && document.activeElement.id === 'roomChatInput'){ e.preventDefault(); roomChatSendFromPopup(); }
  });

  // quick join helper
  function quickJoin(code){ document.getElementById('roomInput').value = code; joinRoom(); }

  // auto rejoin on page reload
  window.addEventListener('beforeunload', ()=>{
    // mark offline on unexpected unload if in room
    if(window.currentRoom && window.currentUser){
      db.ref(`snakeRooms/${window.currentRoom}/players/${window.currentUser.uid}/online`).set(false);
      db.ref(`snakeRooms/${window.currentRoom}/players/${window.currentUser.uid}/lastSeen`).set(Date.now());
    }
  });

  // minimal toast
  function showToast(m){ console.log('[toast]',m); }

  </script>

  <script>
/* ======== SNAKE & LADDER GAMEPLAY (PART 2) ======== */

/* --- fixed snakes & ladders map --- */
const ladders = {4:14, 9:31, 20:38, 28:84, 40:59, 51:67, 63:81, 71:91};
const snakes  = {17:7, 54:34, 62:19, 64:60, 87:24, 93:73, 95:75, 99:78};

/* --- simple emoji tokens --- */
const tokenIcons = ['üè†','üöó','üíé','üê±','üíÄ','üß∏'];

/* --- build 10√ó10 board --- */
function buildBoard(){
  const popup = document.getElementById('roomBoardPopup');
  let html = `<div id="boardGrid" style="display:grid;grid-template-columns:repeat(10,1fr);gap:1px;background:#333;">`;
  for(let r=9;r>=0;r--){
    const rowIndex = r;
    const rowStart = rowIndex*10+1;
    for(let c=0;c<10;c++){
      let idx = rowIndex%2===0 ? rowStart+c : rowStart+(9-c);
      if(r===9) idx = (rowIndex%2===0)? c+1 : 10-c;
      const bg = ((r+c)%2===0)?'#ffe8f7':'#fff4fb';
      html += `<div id="cell${idx}" style="background:${bg};position:relative;aspect-ratio:1;border:1px solid rgba(0,0,0,0.1);font-size:11px;text-align:right;padding:2px;">${idx}</div>`;
    }
  }
  html += `</div>`;
  popup.innerHTML = html;
}

/* --- place all players tokens --- */
function renderTokens(room){
  if(!room) return;
  const players = room.players || {};
  Object.values(players).forEach(p=>{
    const cell = document.getElementById('cell'+p.pos);
    if(!cell) return;
    const id = 'token-'+p.id;
    let token = document.getElementById(id);
    if(!token){
      token = document.createElement('div');
      token.id = id;
      token.style.position='absolute';
      token.style.left='2px';
      token.style.top='18px';
      token.style.fontSize='20px';
      cell.appendChild(token);
    }else{
      token.remove();
      cell.appendChild(token);
    }
    token.textContent = tokenIcons[p.tokenIndex % tokenIcons.length];
  });
}

/* --- dice rolling panel --- */
function setupDice(){
  const panel = document.getElementById('dicePopup');
  panel.innerHTML = `<h4>üé≤ Dice</h4>
  <div id="diceDisplay" style="font-size:42px;text-align:center;margin:6px 0;">‚öÄ</div>
  <button id="rollBtn" onclick="rollDice()">Roll</button>
  <div id="turnInfo" class="muted-small" style="text-align:center;margin-top:4px"></div>`;
}

/* --- render whose turn it is --- */
function updateTurnInfo(room){
  if(!room) return;
  const turnOrder = room.turnOrder || [];
  const turnIdx = room.currentTurn || 0;
  const uid = turnOrder[turnIdx];
  const name = room.players && room.players[uid] ? room.players[uid].name : '?';
  const info = document.getElementById('turnInfo');
  if(info) info.textContent = `Turn: ${name}`;
  const btn = document.getElementById('rollBtn');
  if(!btn) return;
  btn.disabled = !(window.currentUser && uid === window.currentUser.uid && room.started);
}

/* --- roll dice handler --- */
async function rollDice(){
  if(!window.currentRoom || !window.currentUser) return;
  const rRef = db.ref('snakeRooms/'+window.currentRoom);
  const snap = await rRef.get();
  if(!snap.exists()) return;
  const room = snap.val();
  const turnUid = (room.turnOrder||[])[room.currentTurn||0];
  if(turnUid !== window.currentUser.uid) return alert('Not your turn!');
  const dice = Math.floor(Math.random()*6)+1;
  animateDice(dice);
  movePlayer(room, dice);
}

/* --- animate dice emoji --- */
function animateDice(val){
  const diceChar = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][val-1];
  const el = document.getElementById('diceDisplay');
  if(!el) return;
  el.textContent = diceChar;
  el.style.transform='scale(1.3)';
  setTimeout(()=>{ el.style.transform='scale(1)'; },300);
}

/* --- move player logic --- */
async function movePlayer(room, steps){
  const uid = window.currentUser.uid;
  const player = room.players[uid];
  let newPos = player.pos + steps;
  if(newPos>100) newPos = 100 - (newPos-100); // bounce back
  if(ladders[newPos]) newPos = ladders[newPos];
  if(snakes[newPos]) newPos = snakes[newPos];
  await db.ref(`snakeRooms/${window.currentRoom}/players/${uid}/pos`).set(newPos);
  await db.ref(`snakeRooms/${window.currentRoom}/_lastLog`).set(`${player.name} rolled ${steps} ‚Üí ${newPos}`);
  // check winner
  if(newPos===100){
    await db.ref(`snakeRooms/${window.currentRoom}/_lastLog`).set(`üéâ ${player.name} reached 100 and wins!`);
    alert(`üéâ ${player.name} wins!`);
    return;
  }
  // next turn
  const order = room.turnOrder||[];
  let idx = (room.currentTurn||0)+1;
  if(idx>=order.length) idx=0;
  await db.ref(`snakeRooms/${window.currentRoom}/currentTurn`).set(idx);
}

/* --- listen to room updates for board changes --- */
function subscribeRoomForBoard(code){
  const rRef = db.ref('snakeRooms/'+code);
  const cb = rRef.on('value', snap=>{
    if(!snap.exists()) return;
    const room = snap.val();
    renderTokens(room);
    updateTurnInfo(room);
  });
  window.roomBoardListener = ()=>rRef.off('value',cb);
}

/* --- hook board + dice after join --- */
const origJoinRoomByCode = joinRoomByCode;
joinRoomByCode = function(code, created){
  origJoinRoomByCode(code, created);
  buildBoard();
  setupDice();
  if(window.roomBoardListener) window.roomBoardListener();
  subscribeRoomForBoard(code);
};

/* --- cleanup on leave --- */
const origAttemptLeaveRoom = attemptLeaveRoom;
attemptLeaveRoom = async function(force){
  if(window.roomBoardListener){ window.roomBoardListener(); window.roomBoardListener=null; }
  await origAttemptLeaveRoom(force);
  document.getElementById('roomBoardPopup').innerHTML='';
  document.getElementById('dicePopup').innerHTML='';
};

/* --- initial board when popup toggled --- */
document.getElementById('btnShowBoard').addEventListener('click',()=>{
  const popup = document.getElementById('roomBoardPopup');
  if(!popup.innerHTML) buildBoard();
});

/* --- done --- */
console.log("Snake & Ladder Part 2 loaded");
  </script>

    <footer class="page-footer">
    Created by <strong>NZM</strong><br>
    &copy; 2025 | To God Be the Glory
  </footer>
</body>
</html>
