<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV</title>

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <!-- Load your channels file (must remain here, before the main script below) -->
  <script src="channels.js"></script>

  <link rel="icon" href="logo.png" type="image/png" />

  <style>
    :root{
      --accent: #00b7ff;     /* bright cyan */
      --accent2:#007aff;     /* deep blue */
      --bg-dark:#050b18;     /* midnight */
      --bg-panel:#0d1630;    /* panel */
      --text:#e9f6ff;
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(233,246,255,0.7);
      --radius: 12px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, Poppins, Arial, sans-serif}
    html,body{height:100%;background:linear-gradient(180deg,var(--bg-dark),#061027);color:var(--text);}

    .app{display:flex;height:100vh;overflow:hidden}

/* Sidebar */
    .sidebar{
      width:320px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-right:1px solid rgba(255,255,255,0.02);
      padding:14px;display:flex;flex-direction:column;gap:12px;transition:transform .28s ease;z-index:50;
      background-color:var(--bg-panel);
    }
    .sidebar.collapsed{transform:translateX(-110%)}
    .sb-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:44px;border-radius:8px}
    .brand h2{font-size:16px;color:var(--accent);letter-spacing:0.4px}
    .controls{display:flex;gap:8px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}

    .filters{display:flex;flex-direction:column;gap:8px}
    .search{padding:10px;border-radius:10px;border:none;background:#071d33;color:var(--muted);outline:none}
    .select{padding:9px;border-radius:10px;border:none;background:#071d33;color:var(--muted);outline:none}

    .channels{flex:1;overflow:auto;padding-right:6px}
    .channels::-webkit-scrollbar{width:8px}
    .channels::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent2));border-radius:8px;opacity:0.9}

    .channel{
      display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:var(--glass);margin-bottom:8px;cursor:pointer;transition:all .12s ease;border:1px solid transparent;
    }
    .channel:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(2,6,23,0.6);border-color:rgba(0,183,255,0.08)}
    .channel img{width:72px;height:44px;object-fit:cover;border-radius:6px;flex-shrink:0}
    .ch-meta{flex:1}
    .ch-name{font-weight:700;color:var(--text)}
    .ch-cat{font-size:12px;color:rgba(233,246,255,0.6)}
    .fav-btn{padding:6px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:16px}

/* Main */
    .main{flex:1;display:flex;flex-direction:column;align-items:center;gap:14px;padding:18px;overflow:auto}

/* Topbar */
    .topbar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:transparent;position:fixed;top:0;z-index:40}
    .left{display:flex;gap:12px;align-items:center}
    .hamb{display:none;cursor:pointer;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
    .title{font-size:18px;color:var(--accent);text-shadow:0 0 8px rgba(0,119,255,0.06);font-weight:700}

/* Player */
    .player-wrap{width:min(1100px,95%);aspect-ratio:16/9;border-radius:16px;overflow:hidden;background:#000;position:relative;margin-top:72px;box-shadow:0 24px 70px rgba(0,0,0,0.7)}
    video,iframe{width:100%;height:100%;display:block;background:#000}
    .now-badge{position:absolute;left:14px;top:12px;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.25));padding:8px 12px;border-radius:10px;display:flex;gap:10px;align-items:center}
    .now-badge img{width:48px;height:36px;border-radius:6px;object-fit:cover;display:block}
    .now-title{font-weight:700}
    .player-actions{position:absolute;right:14px;top:12px;display:flex;gap:8px}
    .action{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

/* Now card and history */
    .now-card{width:min(1100px,95%);display:flex;gap:16px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
    .now-card img{width:96px;height:64px;object-fit:cover;border-radius:8px;display:none}
    .meta-rows{flex:1}
    .meta-title{font-weight:700;color:var(--text)}
    .meta-epg{font-size:13px;color:rgba(233,246,255,0.7)}

/* History modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:90}
    .modal .box{width:min(800px,95%);max-height:70vh;overflow:auto;background:linear-gradient(180deg,#07122a,#041026);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .history-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);color:var(--muted)}

/* Responsive */
    @media(max-width:900px){ .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:60} .hamb{display:block} .player-wrap{margin-top:110px}}
  </style>
</head>
<body>
  <div class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sb-head">
        <div class="brand">
          <img src="mwlogo.png" alt="logo">
          <h2>NZM IPTV</h2>
        </div>
        <div class="controls">
          <button id="collapseBtn" class="btn" title="Toggle sidebar">☰</button>
          <button id="historyBtn" class="btn" title="Watch history">📜</button>
        </div>
      </div>

      <div class="filters">
        <input id="search" class="search" placeholder="Search channels or categories..." />
        <select id="category" class="select"><option value="all">All Categories</option><option value="favorites">★ Favorites</option></select>
      </div>

      <div class="channels" id="channelList" aria-live="polite"></div>

      <div style="font-size:12px;color:rgba(255,255,255,0.4);padding-top:8px">Favorites saved locally • Watch history stored</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="left">
          <button class="hamb" id="mobileMenu">☰</button>
          <div class="title">NZM IPTV</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="pipBtn" class="action" title="PiP">⧉ PiP</button>
          <button id="prevBtn" class="action" title="Previous">◀</button>
          <button id="nextBtn" class="action" title="Next">▶</button>
        </div>
      </div>

      <div class="player-wrap" id="playerWrap">
        <div class="now-badge" id="nowBadge" style="display:none">
          <img id="nowLogo" src="" alt="logo">
          <div>
            <div class="now-title" id="nowName">—</div>
            <div style="font-size:13px;color:var(--muted)" id="nowEpg">—</div>
          </div>
        </div>

        <div class="player-actions">
          <button id="favToggle" class="action">♡</button>
          <button id="reloadBtn" class="action">⟳</button>
        </div>

        <iframe id="iframe" style="display:none;border:0;height:100%;width:100%" allowfullscreen></iframe>
        <video id="video" controls playsinline crossorigin="anonymous" style="background:#000;display:none">Your browser doesn't support the video tag.</video>
      </div>

      <div class="now-card" id="nowCard">
        <img id="cardLogo" src="" alt="logo">
        <div class="meta-rows">
          <div class="meta-title" id="cardTitle">No channel</div>
          <div class="meta-epg" id="cardEpg">—</div>
        </div>
        <div style="text-align:right;font-size:12px;color:rgba(255,255,255,0.6)">
          <div id="lastPlayed">Last: —</div>
          <div id="historyCount">History: 0</div>
        </div>
      </div>
    </main>
  </div>

  <!-- History modal -->
  <div class="modal" id="historyModal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--accent)">Watch History</div>
        <div>
          <button id="clearHistory" class="btn">Clear</button>
          <button id="closeHistory" class="btn">Close</button>
        </div>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    /***** Core variables *****/
    // Use combinedChannels (your channels.js should define this)
    const combinedChannels = window.combinedChannels || window.channels || window.nzmChannels || [];

    // DOM refs
    const channelList = document.getElementById('channelList');
    const searchInput = document.getElementById('search');
    const categorySelect = document.getElementById('category');
    const video = document.getElementById('video');
    const iframe = document.getElementById('iframe');
    const nowBadge = document.getElementById('nowBadge');
    const nowLogo = document.getElementById('nowLogo');
    const nowName = document.getElementById('nowName');
    const nowEpg = document.getElementById('nowEpg');
    const favToggle = document.getElementById('favToggle');
    const reloadBtn = document.getElementById('reloadBtn');
    const pipBtn = document.getElementById('pipBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const cardTitle = document.getElementById('cardTitle');
    const cardEpg = document.getElementById('cardEpg');
    const cardLogo = document.getElementById('cardLogo');
    const lastPlayed = document.getElementById('lastPlayed');
    const historyCount = document.getElementById('historyCount');
    const collapseBtn = document.getElementById('collapseBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = document.getElementById('historyModal');
    const historyList = document.getElementById('historyList');
    const clearHistory = document.getElementById('clearHistory');
    const closeHistory = document.getElementById('closeHistory');

    // state
    let hls = null;
    let shakaPlayer = null;
    let currentIndex = -1;
    let favorites = JSON.parse(localStorage.getItem('nzm_favorites') || '[]');
    let history = JSON.parse(localStorage.getItem('nzm_history') || '[]');

    /***** helpers *****/
    function saveFavs(){ localStorage.setItem('nzm_favorites', JSON.stringify(favorites)); }
    function saveHistory(){ localStorage.setItem('nzm_history', JSON.stringify(history)); updateHistoryUI(); }
    function updateHistoryUI(){
      historyCount.textContent = 'History: ' + history.length;
      lastPlayed.textContent = history.length ? 'Last: ' + new Date(history[history.length-1].when).toLocaleString() : 'Last: —';
      // populate modal list
      historyList.innerHTML = '';
      if(!history.length){ historyList.innerHTML = '<div style="color:var(--muted);padding:8px">No history yet</div>'; return; }
      history.slice().reverse().forEach(h => {
        const el = document.createElement('div');
        el.className = 'history-item';
        el.innerHTML = `<div>${h.channel}</div><div style="opacity:.8">${new Date(h.when).toLocaleString()}</div>`;
        historyList.appendChild(el);
      });
    }

    function fuzzyMatch(a, q){ return (a||'').toLowerCase().includes((q||'').toLowerCase()); }

    function buildCategories(){
      const cats = new Set();
      combinedChannels.forEach(ch => { if(ch.category) cats.add(ch.category); });
      categorySelect.innerHTML = '<option value="all">All Categories</option><option value="favorites">★ Favorites</option>';
      Array.from(cats).sort().forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; categorySelect.appendChild(opt);
      });
    }

    function showSkeleton(){
      channelList.innerHTML = '';
      for(let i=0;i<6;i++){ const s = document.createElement('div'); s.style.height='64px'; s.style.marginBottom='10px'; s.style.background='linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))'; s.style.borderRadius='10px'; channelList.appendChild(s); }
    }

    /***** render channels *****/
    function renderChannels(){
      showSkeleton();
      setTimeout(()=>{ // small debounce for smoother UI
        const q = searchInput.value.trim().toLowerCase();
        const sel = categorySelect.value;
        channelList.innerHTML = '';
        let indices = combinedChannels.map((_,i)=>i);

        if(sel === 'favorites') indices = indices.filter(i => favorites.includes(i));
        else if(sel !== 'all') indices = indices.filter(i => (combinedChannels[i].category||'').toLowerCase() === sel.toLowerCase());

        if(q) indices = indices.filter(i => {
          const c = combinedChannels[i];
          return fuzzyMatch(c.name, q) || fuzzyMatch(c.category, q);
        });

        if(indices.length === 0){
          const p = document.createElement('div');
          p.style.padding='12px';
          p.style.color='var(--muted)';
          p.textContent = 'No channels found';
          channelList.appendChild(p);
          return;
        }

        indices.forEach(idx => {
          const ch = combinedChannels[idx];
          const el = document.createElement('div'); el.className = 'channel';
          const img = document.createElement('img'); img.src = ch.logo || 'logo.png'; img.alt = ch.name || 'logo';
          const info = document.createElement('div'); info.className = 'ch-meta';
          const name = document.createElement('div'); name.className = 'ch-name'; name.textContent = ch.name || 'No name';
          const cat = document.createElement('div'); cat.className = 'ch-cat'; cat.textContent = (ch.category || '') + (ch.type ? ' • ' + ch.type.toUpperCase() : '');
          info.appendChild(name); info.appendChild(cat);
          const favBtn = document.createElement('button'); favBtn.className='fav-btn'; favBtn.innerHTML = favorites.includes(idx) ? '❤️' : '♡';
          favBtn.onclick = (e) => { e.stopPropagation(); toggleFav(idx, favBtn); };
          el.appendChild(img); el.appendChild(info); el.appendChild(favBtn);
          el.onclick = () => playChannel(idx);
          channelList.appendChild(el);
        });
      },180);
    }

    function toggleFav(idx, btn){
      const i = favorites.indexOf(idx);
      if(i >= 0) favorites.splice(i,1); else favorites.push(idx);
      btn.innerHTML = favorites.includes(idx) ? '❤️':'♡';
      saveFavs();
    }

    /***** player controls *****/
    function stopAll(){
      if(hls){ try{ hls.destroy(); }catch(e){} hls = null; }
      if(shakaPlayer){ try{ shakaPlayer.unload(); }catch(e){} shakaPlayer = null; }
      try{ video.pause(); video.removeAttribute('src'); video.load(); }catch(e){}
      video.style.display = 'none';
      iframe.style.display = 'none';
      iframe.src = '';
    }

    async function playChannel(idx){
      if(!combinedChannels[idx]) return alert('Channel not available');
      currentIndex = idx;
      const ch = combinedChannels[idx];

      // UI updates
      nowName.textContent = ch.name || '—';
      nowEpg.textContent = (ch.epg && ch.epg[0]) ? (ch.epg[0][0] + ' • ' + ch.epg[0][1]) : 'No EPG';
      cardTitle.textContent = ch.name || 'No channel';
      cardEpg.textContent = nowEpg.textContent;
      if(ch.logo){ nowLogo.src = ch.logo; nowLogo.style.display = 'block'; cardLogo.src = ch.logo; cardLogo.style.display = 'block'; }
      else { nowLogo.style.display = 'none'; cardLogo.style.display = 'none'; }
      favToggle.textContent = favorites.includes(idx) ? '❤️' : '♡';

      // add history
      history.push({ when: Date.now(), channel: ch.name || ('#'+idx) });
      if(history.length > 300) history.shift();
      saveHistory();

      // load
      stopAll();
      try{
        // youtube iframe (works if URL is embedded link)
        if(ch.type === 'youtube' || (ch.url && (ch.url.includes('youtube.com') || ch.url.includes('youtu.be')))){
          iframe.style.display = 'block';
          const sep = ch.url.includes('?') ? '&' : '?';
          iframe.src = ch.url + sep + 'autoplay=1&rel=0';
          return;
        }

        // HLS
        if(ch.type === 'hls' || (ch.url && ch.url.endsWith('.m3u8'))){
          video.style.display = 'block';
          if(Hls.isSupported()){
            hls = new Hls({ lowLatencyMode:true });
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
            hls.on(Hls.Events.ERROR, (ev,data)=> console.warn('HLS error', data));
          } else if(video.canPlayType('application/vnd.apple.mpegurl')){
            video.src = ch.url;
            video.play().catch(()=>{});
          } else {
            alert('HLS not supported in this browser');
          }
          return;
        }

        // DASH
        if(ch.type === 'dash' || (ch.url && ch.url.endsWith('.mpd'))){
          video.style.display = 'block';
          shaka.polyfill.installAll();
          if(!shaka.Player.isBrowserSupported()){ alert('Shaka not supported in this browser'); return; }
          shakaPlayer = new shaka.Player(video);
          if(ch.clearKey) shakaPlayer.configure({ drm: { clearKeys: ch.clearKey } });
          await shakaPlayer.load(ch.url);
          video.play().catch(()=>{});
          return;
        }

        // fallback direct
        if(ch.url){
          video.style.display = 'block';
          video.src = ch.url;
          await video.play().catch(()=>{});
          return;
        }

        alert('No playable URL found for this channel');
      }catch(err){
        console.error('Playback error', err); alert('Playback error: ' + (err && err.message ? err.message : err));
      }
    }

    function getFilteredIndices(){
      const q = (searchInput.value||'').toLowerCase();
      const sel = categorySelect.value;
      let ids = combinedChannels.map((_,i)=>i);
      if(sel === 'favorites') ids = ids.filter(i => favorites.includes(i));
      else if(sel !== 'all') ids = ids.filter(i => ((combinedChannels[i].category||'').toLowerCase() === sel.toLowerCase()));
      if(q) ids = ids.filter(i => {
        const c = combinedChannels[i];
        return (c.name||'').toLowerCase().includes(q) || (c.category||'').toLowerCase().includes(q);
      });
      return ids;
    }

    function nextChannel(){ if(currentIndex < 0) return; const list = getFilteredIndices(); const pos = list.indexOf(currentIndex); if(pos === -1 && list.length) playChannel(list[0]); else if(pos+1 < list.length) playChannel(list[pos+1]); }
    function prevChannel(){ if(currentIndex < 0) return; const list = getFilteredIndices(); const pos = list.indexOf(currentIndex); if(pos === -1 && list.length) playChannel(list[list.length-1]); else if(pos-1 >= 0) playChannel(list[pos-1]); }

    // PiP
    pipBtn.addEventListener('click', async () => {
      try{
        if(document.pictureInPictureElement){ await document.exitPictureInPicture(); return; }
        if(video.style.display !== 'block') return alert('PiP works only for video streams');
        await video.requestPictureInPicture();
      }catch(e){ alert('PiP failed: ' + (e && e.message ? e.message : e)); }
    });

       // reload
    reloadBtn.addEventListener('click', ()=>{ if(currentIndex >= 0) playChannel(currentIndex); });

    // fav toggle on player
    favToggle.addEventListener('click', ()=>{ if(currentIndex < 0) return; const i = favorites.indexOf(currentIndex); if(i >= 0) favorites.splice(i,1); else favorites.push(currentIndex); saveFavs(); favToggle.textContent = favorites.includes(currentIndex) ? '❤️' : '♡'; renderChannels(); });

    // keyboard nav
    document.addEventListener('keydown', (e)=>{ if(e.key === 'ArrowLeft') prevChannel(); if(e.key === 'ArrowRight') nextChannel(); if(e.key === 'f' && currentIndex >= 0){ const i = favorites.indexOf(currentIndex); if(i >= 0) favorites.splice(i,1); else favorites.push(currentIndex); saveFavs(); favToggle.textContent = favorites.includes(currentIndex) ? '❤️':'♡'; renderChannels(); } });

    // UI bindings
    searchInput.addEventListener('input', renderChannels);
    categorySelect.addEventListener('change', renderChannels);
    nextBtn.addEventListener('click', nextChannel);
    prevBtn.addEventListener('click', prevChannel);

    collapseBtn.addEventListener('click', ()=>{ document.querySelector('.sidebar').classList.toggle('collapsed'); localStorage.setItem('nzm_sidebar_collapsed', document.querySelector('.sidebar').classList.contains('collapsed')); });
    mobileMenu.addEventListener('click', ()=>{ document.querySelector('.sidebar').classList.toggle('collapsed'); });

    // history modal
    historyBtn.addEventListener('click', ()=>{ historyModal.style.display = 'flex'; updateHistoryUI(); });
    closeHistory.addEventListener('click', ()=> historyModal.style.display = 'none');
    clearHistory.addEventListener('click', ()=>{ if(confirm('Clear watch history?')){ history = []; saveHistory(); updateHistoryUI(); } });

    historyModal.addEventListener('click', (ev)=>{ if(ev.target === historyModal) historyModal.style.display = 'none'; });

    // persist last played
    window.addEventListener('beforeunload', ()=>{ if(currentIndex >= 0) localStorage.setItem('nzm_last_index', currentIndex); localStorage.setItem('nzm_sidebar_collapsed', document.querySelector('.sidebar').classList.contains('collapsed')); });

    /***** init on load *****/
    document.addEventListener('DOMContentLoaded', ()=>{
      // ensure shaka polyfills are installed
      shaka && shaka.polyfill && shaka.polyfill.installAll?.();

      // build UI
      if(!combinedChannels || !combinedChannels.length){
        channelList.innerHTML = '<div style="padding:12px;color:var(--muted)">⚠️ No channels loaded from channels.js — make sure channels.js is present and defines combinedChannels</div>';
        return;
      }

      // restore sidebar state
      if(localStorage.getItem('nzm_sidebar_collapsed') === 'true') document.querySelector('.sidebar').classList.add('collapsed');

      buildCategories();
      renderChannels();
      updateHistoryUI();

      // resume last
      const last = parseInt(localStorage.getItem('nzm_last_index') || '-1', 10);
      if(!isNaN(last) && last >= 0 && last < combinedChannels.length){
        // Attempt to resume last channel quietly
        playChannel(last);
      }
    });

    // expose for debugging
    window.NZM = { playChannel, combinedChannels, favorites, history, renderChannels };
  </script>
</body>
</html>
  
