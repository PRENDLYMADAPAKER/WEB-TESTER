<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NZM IPTV</title>

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <link rel="icon" href="logo.png" type="image/png" />

  <style>
    :root {
      --accent: #00e0ff;
      --accent2: #009dff;
      --bg-dark: #0b1520;
      --bg-panel: #12283a;
      --text: #e9f6ff;
      --glass: rgba(255,255,255,0.06);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Poppins, Arial, sans-serif; }
    body {
      display: flex;
      height: 100vh;
      background: linear-gradient(145deg, var(--bg-dark), #0e1b2a);
      color: var(--text);
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 300px;
      background: var(--bg-panel);
      border-right: 2px solid #0a1c2b;
      display: flex;
      flex-direction: column;
      transition: transform .3s ease;
      z-index: 100;
    }
    #sidebar.collapsed { transform: translateX(-100%); }

    #sidebar header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      border-bottom: 1px solid #1d3a55;
      background: rgba(0,0,0,0.2);
    }
    #sidebar header img {
      height: 40px;
      filter: drop-shadow(0 0 6px var(--accent));
    }
    #toggleMenu {
      font-size: 24px;
      cursor: pointer;
      display: none;
      color: var(--accent);
    }

    /* Filters */
    #filterBar {
      padding: 10px;
      display: flex;
      gap: 8px;
      flex-direction: column;
    }
    #searchInput, #categorySelect {
      width: 100%;
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: #0b1f33;
      color: var(--text);
      outline: none;
    }
    #searchInput:focus, #categorySelect:focus {
      border: 1px solid var(--accent);
      box-shadow: 0 0 5px var(--accent);
    }

    /* Channel list */
    #channelList {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    #channelList::-webkit-scrollbar { width: 6px; }
    #channelList::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 6px; }
    .channel {
      background: var(--glass);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor: pointer;
      transition: all .12s ease;
      border: 1px solid transparent;
    }
    .channel:hover {
      background: rgba(0,157,255,0.08);
      color: #fff;
      transform: translateY(-3px);
      border-color: var(--accent);
    }
    .channel img{ width:56px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0 }
    .channel .meta{flex:1}
    .channel .meta .name{font-weight:600}
    .fav-btn{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:8px;cursor:pointer}

    /* Main */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      overflow: hidden;
    }

    /* Top bar */
    #topbar {
      position: fixed;
      top: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(10,25,40,0.95);
      border-bottom: 2px solid #0a2a40;
      z-index: 99;
      backdrop-filter: blur(6px);
      height:64px;
    }
    #topbar h1 {
      color: var(--accent);
      font-size: 20px;
      text-shadow: 0 0 8px var(--accent2);
      font-weight: 600;
      margin-left:6px;
    }
    #menuBtn {
      font-size: 28px;
      cursor: pointer;
      display: none;
      color: var(--accent);
    }

    /* Video container */
    #videoContainer {
      position: relative;
      width: 80%;
      max-width: 960px;
      aspect-ratio: 16 / 9;
      margin-top: 100px; /* leave space for topbar */
      border-radius: 20px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
    }
    video, iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
    }

    #nowPlaying {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 14px;
      pointer-events: none;
      display:flex;
      gap:10px;
      align-items:center;
    }

    #loadingOverlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 18px;
      backdrop-filter: blur(4px);
    }

    .player-actions {
      position: absolute;
      right: 12px;
      top: 12px;
      display: flex;
      gap: 8px;
    }
    .player-actions button { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.03); color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer }

    /* now card beneath */
    #nowCard {
      margin-top: 16px;
      width: 80%;
      max-width: 960px;
      background: rgba(255,255,255,0.02);
      padding: 12px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      gap:12px;
      color:var(--text);
    }
    #nowCard img { width:86px;height:56px;object-fit:cover;border-radius:8px;display:none }

    /* Mobile adjustments */
    @media(max-width: 768px){
      #toggleMenu, #menuBtn { display: block; }
      #sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index:200; }
      #main { flex: 1; overflow-y: auto; }
      #videoContainer { width: 95%; margin-top: 120px; }
      #topbar h1 { font-size: 18px; }
      .channel img{ width:46px;height:36px }
      #nowCard { width: 95% }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <img src="mwlogo.png" alt="Logo">
        <div style="line-height:1">
          <div style="font-weight:700;color:var(--accent)">NZM IPTV</div>
          <div style="font-size:11px;color:rgba(255,255,255,0.5)">WEB PLAYER</div>
        </div>
      </div>
      <span id="toggleMenu">âœ–</span>
    </header>

    <div id="filterBar">
      <input type="text" id="searchInput" placeholder="ðŸ” Search channel..." />
      <select id="categorySelect"><option value="all">All Categories</option></select>
    </div>
    <div id="channelList"></div>
  </aside>

  <!-- Main -->
  <main id="main">
    <div id="topbar">
      <span id="menuBtn">â˜°</span>
      <h1>NZM IPTV</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="pipBtn" title="Picture in Picture">PiP</button>
        <button id="prevBtn" title="Previous">â—€</button>
        <button id="nextBtn" title="Next">â–¶</button>
      </div>
    </div>

    <div id="videoContainer">
      <div id="nowPlaying">Now: â€”</div>
      <div id="loadingOverlay">Loading...</div>

      <div class="player-actions">
        <button id="favToggle" title="Toggle Favorite">â™¡</button>
        <button id="reloadBtn" title="Reload">âŸ³</button>
      </div>

      <iframe id="videoFrame" allowfullscreen></iframe>
      <video id="videoPlayer" controls playsinline></video>
    </div>

    <div id="nowCard">
      <img id="cardLogo" src="" alt="logo">
      <div style="flex:1">
        <div id="cardTitle" style="font-weight:700;color:var(--accent)">No channel</div>
        <div id="cardEpg" style="color:rgba(255,255,255,0.7)">â€”</div>
      </div>
      <div style="text-align:right;font-size:12px;color:rgba(255,255,255,0.6)">
        <div id="lastPlayed">Last: â€”</div>
        <div id="historyCount">History: 0</div>
      </div>
    </div>
  </main>

  <script>
    // --- Use your channels.js combinedChannels variable if present ---
    const combinedChannels = (typeof window.combinedChannels !== 'undefined') ? window.combinedChannels : [];

    // DOM
    const sidebar = document.getElementById('sidebar');
    const toggleMenu = document.getElementById('toggleMenu');
    const menuBtn = document.getElementById('menuBtn');
    const channelList = document.getElementById('channelList');
    const video = document.getElementById('videoPlayer');
    const iframe = document.getElementById('videoFrame');
    const nowPlaying = document.getElementById('nowPlaying');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const favToggle = document.getElementById('favToggle');
    const pipBtn = document.getElementById('pipBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const cardTitle = document.getElementById('cardTitle');
    const cardEpg = document.getElementById('cardEpg');
    const cardLogo = document.getElementById('cardLogo');
    const lastPlayed = document.getElementById('lastPlayed');
    const historyCount = document.getElementById('historyCount');

    // state
    let hls = null, shakaPlayer = null;
    let currentIndex = -1;
    let favorites = JSON.parse(localStorage.getItem('nzm_favorites') || '[]');
    let history = JSON.parse(localStorage.getItem('nzm_history') || '[]');

    // helpers
    function saveFavs(){ localStorage.setItem('nzm_favorites', JSON.stringify(favorites)); }
    function saveHistory(){ localStorage.setItem('nzm_history', JSON.stringify(history)); updateHistoryUI(); }
    function updateHistoryUI(){ historyCount.textContent = 'History: ' + history.length; lastPlayed.textContent = history.length ? 'Last: ' + new Date(history[history.length-1].when).toLocaleString() : 'Last: â€”'; }

    function buildCategories() {
      const cats = new Set();
      combinedChannels.forEach(ch => { if (ch.category) cats.add(ch.category); });
      categorySelect.innerHTML = '<option value="all">All Categories</option><option value="favorites">â˜… Favorites</option>';
      Array.from(cats).sort().forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    function showLoading(on = true) {
      loadingOverlay.style.display = on ? 'flex' : 'none';
    }

    function stopAllPlayers(){
      if (hls) { try { hls.destroy(); } catch(e) {} hls = null; }
      if (shakaPlayer) { try { shakaPlayer.unload(); } catch(e) {} shakaPlayer = null; }
      try { video.pause(); video.removeAttribute('src'); video.load(); } catch(e) {}
      video.style.display = 'none';
      iframe.style.display = 'none';
      iframe.src = '';
    }

    function renderChannels(){
      channelList.innerHTML = '';
      const q = (searchInput.value || '').toLowerCase();
      const sel = categorySelect.value;

      // choose which indices to show from combinedChannels
      let indices = combinedChannels.map((c,i) => i);

      if (sel === 'favorites') {
        indices = indices.filter(i => favorites.includes(i));
      } else if (sel !== 'all') {
        indices = indices.filter(i => (combinedChannels[i].category || '').toLowerCase() === sel.toLowerCase());
      }

      // filter by search
      if (q) {
        indices = indices.filter(i => {
          const c = combinedChannels[i];
          return (c.name || '').toLowerCase().includes(q) || (c.category || '').toLowerCase().includes(q);
        });
      }

      if (indices.length === 0) {
        const p = document.createElement('div');
        p.style.padding = '14px';
        p.style.color = 'rgba(255,255,255,0.6)';
        p.textContent = 'No channels found';
        channelList.appendChild(p);
        return;
      }

      indices.forEach(idx => {
        const ch = combinedChannels[idx];
        const el = document.createElement('div');
        el.className = 'channel';

        const img = document.createElement('img');
        img.src = ch.logo || 'logo.png';
        img.alt = ch.name || 'logo';
        el.appendChild(img);

        const m = document.createElement('div');
        m.className = 'meta';
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = ch.name || 'No name';
        m.appendChild(nm);
        const sub = document.createElement('div');
        sub.style.fontSize = '12px';
        sub.style.opacity = 0.8;
        sub.textContent = (ch.category || '') + (ch.type ? ' â€¢ ' + ch.type.toUpperCase() : '');
        m.appendChild(sub);
        el.appendChild(m);

        const favBtn = document.createElement('button');
        favBtn.className = 'fav-btn';
        favBtn.innerHTML = favorites.includes(idx) ? 'â¤ï¸' : 'â™¡';
        favBtn.onclick = (ev) => { ev.stopPropagation(); toggleFav(idx, favBtn); };
        el.appendChild(favBtn);

        el.onclick = () => playChannel(idx);
        channelList.appendChild(el);
      });
    }

    function toggleFav(idx, btn){
      const i = favorites.indexOf(idx);
      if (i >= 0) favorites.splice(i, 1);
      else favorites.push(idx);
      btn.innerHTML = favorites.includes(idx) ? 'â¤ï¸' : 'â™¡';
      saveFavs();
    }

    async function playChannel(idx){
      if (!combinedChannels[idx]) return alert('Channel data not available');
      currentIndex = idx;
      const ch = combinedChannels[idx];

      // UI updates
      nowPlaying.textContent = 'Now: ' + (ch.name || 'â€”');
      cardTitle.textContent = ch.name || 'No channel';
      cardEpg.textContent = (ch.epg && ch.epg[0]) ? (ch.epg[0][0] + ' â€¢ ' + ch.epg[0][1]) : 'No EPG';
      if (ch.logo) { cardLogo.src = ch.logo; cardLogo.style.display = 'block'; } else { cardLogo.style.display = 'none'; }
      favToggle.textContent = favorites.includes(idx) ? 'â¤ï¸' : 'â™¡';

      // history
      history.push({ when: Date.now(), channel: ch.name || ('#' + idx) });
      if (history.length > 300) history.shift();
      saveHistory();

      showLoading(true);
      stopAllPlayers();

      try {
        // YouTube (iframe) handling (works with embed links)
        if (ch.type === 'youtube' || (ch.url && (ch.url.includes('youtube.com') || ch.url.includes('youtu.be')))) {
          iframe.style.display = 'block';
          iframe.src = ch.url + (ch.url.includes('?') ? '&' : '?') + 'autoplay=1&rel=0';
          showLoading(false);
          return;
        }

        // HLS
        if (ch.type === 'hls' || (ch.url && ch.url.endsWith('.m3u8'))) {
          video.style.display = 'block';
          if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
              video.play().catch(()=>{});
              showLoading(false);
            });
            hls.on(Hls.Events.ERROR, function(event, data){
              console.warn('HLS error', data);
            });
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play().catch(()=>{});
            showLoading(false);
          } else {
            showLoading(false);
            alert('HLS not supported in this browser');
          }
          return;
        }

        // DASH
        if (ch.type === 'dash' || (ch.url && ch.url.endsWith('.mpd'))) {
          video.style.display = 'block';
          shaka.polyfill.installAll();
          if (!shaka.Player.isBrowserSupported()) {
            showLoading(false);
            alert('Shaka Player is not supported in this browser');
            return;
          }
          shakaPlayer = new shaka.Player(video);
          // Try to configure ClearKey if present
          if (ch.clearKey) {
            const keys = ch.clearKey;
            // convert to Shaka format { 'com.widevine.alpha': ... } is not required for ClearKey
            shakaPlayer.getNetworkingEngine && shakaPlayer.configure && shakaPlayer.configure({ drm: { servers: {} } });
            // shaka.clearKeys expects keyId:value pairs (hex)
            shakaPlayer && shakaPlayer.configure({ drm: { clearKeys: keys } });
          }
          await shakaPlayer.load(ch.url);
          video.play().catch(()=>{});
          showLoading(false);
          return;
        }

        // fallback: direct video URL
        if (ch.url) {
          video.style.display = 'block';
          video.src = ch.url;
          await video.play().catch(()=>{});
          showLoading(false);
          return;
        }

        showLoading(false);
        alert('No playable URL found for channel');
      } catch (err) {
        console.error('playChannel error', err);
        showLoading(false);
        alert('Error playing channel: ' + (err && err.message ? err.message : err));
      }
    }

    // next / prev functions
    function nextChannel(){
      if (currentIndex < 0) return;
      // find next index in current category/search
      const idx = getAdjacentIndex(1);
      if (idx !== null) playChannel(idx);
    }
    function prevChannel(){
      if (currentIndex < 0) return;
      const idx = getAdjacentIndex(-1);
      if (idx !== null) playChannel(idx);
    }

    function getFilteredIndices(){
      const q = (searchInput.value || '').toLowerCase();
      const sel = categorySelect.value;
      let indices = combinedChannels.map((c,i)=>i);

      if (sel === 'favorites') indices = indices.filter(i => favorites.includes(i));
      else if (sel !== 'all') indices = indices.filter(i => (combinedChannels[i].category || '').toLowerCase() === sel.toLowerCase());

      if (q) indices = indices.filter(i => {
        const c = combinedChannels[i];
        return (c.name || '').toLowerCase().includes(q) || (c.category || '').toLowerCase().includes(q);
      });

      return indices;
    }

    function getAdjacentIndex(dir){
      const list = getFilteredIndices();
      if (!list.length) return null;
      const pos = list.indexOf(currentIndex);
      if (pos === -1) {
        // if current not in filtered list, choose first or last based on dir
        return dir > 0 ? list[0] : list[list.length - 1];
      }
      let newPos = pos + dir;
      if (newPos < 0 || newPos >= list.length) return null;
      return list[newPos];
    }

    // keyboard
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft') prevChannel();
      if (e.key === 'ArrowRight') nextChannel();
      if (e.key === 'f' && currentIndex >= 0) {
        // toggle fav
        const i = favorites.indexOf(currentIndex);
        if (i >= 0) favorites.splice(i,1); else favorites.push(currentIndex);
        saveFavs();
        favToggle.textContent = favorites.includes(currentIndex) ? 'â¤ï¸' : 'â™¡';
        renderChannels();
      }
    });

    // PiP
    pipBtn.addEventListener('click', async () => {
      try {
        if (document.pictureInPictureElement) { await document.exitPictureInPicture(); return; }
        if (video.style.display !== 'block') return alert('PiP works only for video streams');
        await video.requestPictureInPicture();
      } catch (err) {
        alert('PiP failed: ' + (err && err.message ? err.message : err));
      }
    });

    // reload
    reloadBtn.addEventListener('click', () => {
      if (currentIndex >= 0) playChannel(currentIndex);
    });

        // fav toggle in player
    favToggle.addEventListener('click', () => {
      if (currentIndex < 0) return;
      const i = favorites.indexOf(currentIndex);
      if (i >= 0) favorites.splice(i, 1); else favorites.push(currentIndex);
      saveFavs();
      favToggle.textContent = favorites.includes(currentIndex) ? 'â¤ï¸' : 'â™¡';
      renderChannels();
    });

    // sidebar toggle for mobile
    toggleMenu.addEventListener('click', () => {
      sidebar.classList.add('collapsed');
    });
    menuBtn.addEventListener('click', () => {
      sidebar.classList.remove('collapsed');
    });

    // remember last played
    window.addEventListener('beforeunload', () => {
      if (currentIndex >= 0) localStorage.setItem('nzm_last_index', currentIndex);
      localStorage.setItem('nzm_sidebar_collapsed', sidebar.classList.contains('collapsed'));
    });

    // restore sidebar state & last index on load
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('nzm_sidebar_collapsed') === 'true') sidebar.classList.add('collapsed');
      buildCategories();
      renderChannels();
      updateHistoryUI();

      const last = parseInt(localStorage.getItem('nzm_last_index') || '-1', 10);
      if (!isNaN(last) && last >= 0 && last < combinedChannels.length) {
        // try to resume last played
        playChannel(last);
      }
    });

    // handlers for search / category
    searchInput.addEventListener('input', () => renderChannels());
    categorySelect.addEventListener('change', () => renderChannels());

    // expose for debug in console
    window.nzm = { playChannel, combinedChannels, favorites, history, renderChannels };

  </script>
</body>
</html>
