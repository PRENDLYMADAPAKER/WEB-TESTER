<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WEB IPTV DELUXE — Enhanced</title>

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <!-- favicon -->
  <link rel="icon" href="logo.png" type="image/png" />

  <style>
    :root{
      --accent: #00e0ff;
      --accent2: #009dff;
      --bg: #071221;
      --panel: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.04);
      --muted: rgba(233,246,255,0.65);
      --danger: #ff5c7c;
      --radius: 12px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, Poppins, system-ui, Arial}
    html,body{height:100%;background:linear-gradient(160deg,#041022 0%,#061827 60%);color:var(--muted);}

    /* Layout */
    .app{display:flex;height:100vh;overflow:hidden}

    /* Sidebar */
    .sidebar{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03);padding:14px;display:flex;flex-direction:column;gap:12px;transition:transform .28s ease,width .28s ease}
    .sidebar.collapsed{transform:translateX(-100%)}
    .sb-header{display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:44px;border-radius:8px;filter:drop-shadow(0 6px 18px rgba(0,224,255,0.06))}
    .brand h2{color:var(--accent);font-size:16px;letter-spacing:0.6px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--muted)}
    .controls{display:flex;gap:8px}

    .filter{display:flex;gap:8px;flex-direction:column}
    .search{padding:10px;border-radius:10px;border:none;background:#071e2b;color:var(--muted);outline:none}
    .select{padding:9px;border-radius:10px;border:none;background:#071e2b;color:var(--muted);outline:none}

    .channels{flex:1;overflow:auto;padding-right:8px}
    .channels .skeleton{height:68px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.04),rgba(255,255,255,0.02));border-radius:10px;margin-bottom:10px}

    .channel{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:var(--glass);margin-bottom:8px;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease;border:1px solid transparent}
    .channel:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.6);border-color:rgba(0,224,255,0.08)}
    .channel img{width:56px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0}
    .ch-info{flex:1}
    .ch-name{font-weight:600;color:#e7fcff}
    .ch-meta{font-size:12px;color:rgba(233,246,255,0.6)}
    .fav-btn{font-size:18px;padding:6px;border-radius:8px}

    /* Main area */
    .main{flex:1;display:flex;flex-direction:column;align-items:center;gap:16px;padding:18px;overflow:auto}
    .topbar{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .hamb{display:none;cursor:pointer}
    .title{font-size:18px;color:var(--accent);text-shadow:0 0 8px rgba(0,157,255,0.08)}

    /* Video */
    .player-wrap{width:min(1100px,95%);aspect-ratio:16/9;border-radius:18px;overflow:hidden;background:#000;position:relative;box-shadow:0 18px 60px rgba(0,0,0,0.6)}
    video, iframe{width:100%;height:100%;display:block;background:#000}
    .overlay-controls{position:absolute;left:16px;top:12px;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.2));padding:8px 12px;border-radius:10px;color:#fff;display:flex;align-items:center;gap:8px}
    .now-title{font-weight:700}
    .now-epg{font-size:12px;opacity:0.9}
    .player-actions{position:absolute;right:16px;top:12px;display:flex;gap:8px}
    .action{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent}

    .loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.4));backdrop-filter:blur(4px);font-weight:700}

    /* Now playing card below */
    .now-card{width:min(1100px,95%);display:flex;gap:16px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .now-card img{width:86px;height:56px;object-fit:cover;border-radius:8px}
    .now-meta{flex:1}

    /* footer small controls */
    .mini-controls{display:flex;gap:8px}

    @media(max-width:900px){
      .sidebar{position:fixed;z-index:80;height:100vh}
      .sidebar.collapsed{transform:translateX(-110%)}
      .hamb{display:block}
      .channel img{width:46px;height:34px}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sb-header">
        <div class="brand">
          <img src="mwlogo.png" alt="logo">
          <h2>WEB IPTV DELUXE</h2>
        </div>
        <div class="controls">
          <button id="collapseBtn" class="btn" title="Toggle sidebar">☰</button>
          <button id="themeBtn" class="btn" title="Toggle theme">🌓</button>
        </div>
      </div>

      <div class="filter">
        <input id="search" class="search" placeholder="Search channels or categories..." />
        <select id="category" class="select"><option value="all">All Categories</option></select>
      </div>

      <div class="channels" id="channelList" aria-live="polite"></div>

      <div style="font-size:12px;color:rgba(255,255,255,0.4);padding-top:8px">Favorites saved locally • Watch history kept</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="left">
          <button id="mobileMenu" class="hamb">☰</button>
          <div class="title">WEB IPTV DELUXE — Enhanced</div>
        </div>
        <div class="mini-controls">
          <button id="pipBtn" class="action" title="Picture in Picture">⧉ PiP</button>
          <button id="prevBtn" class="action" title="Previous channel">◀</button>
          <button id="nextBtn" class="action" title="Next channel">▶</button>
        </div>
      </div>

      <div class="player-wrap" id="playerWrap">
        <div id="loading" class="loading" style="display:none">Loading…</div>
        <div class="overlay-controls">
          <div style="display:flex;gap:10px;align-items:center">
            <img id="nowLogo" src="" alt="logo" style="width:42px;height:34px;border-radius:6px;object-fit:cover;display:none">
            <div>
              <div class="now-title" id="nowName">—</div>
              <div class="now-epg" id="nowEpg">—</div>
            </div>
          </div>
        </div>

        <div class="player-actions">
          <button id="favToggle" class="action" title="Toggle Favorite">♡</button>
          <button id="reloadBtn" class="action" title="Reload stream">⟳</button>
        </div>

        <video id="video" controls playsinline crossorigin="anonymous" style="background:#000;">Your browser doesn't support video tag.</video>
        <iframe id="iframe" allowfullscreen style="display:none;border:0;height:100%;width:100%"></iframe>
      </div>

      <div class="now-card" id="nowCard">
        <img id="cardLogo" src="" alt="logo" style="display:none">
        <div class="now-meta">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div>
              <div style="font-weight:700;color:#eaffff" id="cardTitle">No channel</div>
              <div style="font-size:13px;color:rgba(255,255,255,0.6)" id="cardEpg">—</div>
            </div>
            <div style="text-align:right;font-size:12px;color:rgba(255,255,255,0.6)">
              <div id="lastPlayed">Last: —</div>
              <div id="historyCount">History: 0</div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // --- Data source: use combinedChannels from channels.js if available, otherwise use sample data ---
    const sampleChannels = [
      {name:'News Live',url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',logo:'https://picsum.photos/seed/news/200/120',category:'News',type:'hls',epg:[['Morning Show','08:00'],['Noon Update','12:00']]},
      {name:'Sports Arena',url:'https://test-streams.mux.dev/test_001/stream.m3u8',logo:'https://picsum.photos/seed/sports/200/120',category:'Sports',type:'hls',epg:[['Live Match','14:00'],['Highlights','16:00']]},
      {name:'Music TV',url:'https://www.youtube.com/embed/ScMzIvxBSi4',logo:'https://picsum.photos/seed/music/200/120',category:'Music',type:'youtube',epg:[['Top Hits','10:00'],['Chill Mix','18:00']]} 
    ];

    const combinedChannels = (typeof window.combinedChannels !== 'undefined') ? window.combinedChannels : sampleChannels;

    // --- DOM ---
    const sidebar = document.getElementById('sidebar');
    const channelList = document.getElementById('channelList');
    const category = document.getElementById('category');
    const search = document.getElementById('search');
    const video = document.getElementById('video');
    const iframe = document.getElementById('iframe');
    const loading = document.getElementById('loading');
    const nowName = document.getElementById('nowName');
    const nowEpg = document.getElementById('nowEpg');
    const nowLogo = document.getElementById('nowLogo');
    const cardTitle = document.getElementById('cardTitle');
    const cardEpg = document.getElementById('cardEpg');
    const cardLogo = document.getElementById('cardLogo');
    const favToggle = document.getElementById('favToggle');
    const pipBtn = document.getElementById('pipBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const collapseBtn = document.getElementById('collapseBtn');
    const themeBtn = document.getElementById('themeBtn');
    const playerWrap = document.getElementById('playerWrap');
    const lastPlayed = document.getElementById('lastPlayed');
    const historyCount = document.getElementById('historyCount');

    // --- State ---
    let hls = null, shakaPlayer = null;
    let visibleList = [];
    let currentIndex = -1;
    let favorites = JSON.parse(localStorage.getItem('iptv_favs')||'[]');
    let history = JSON.parse(localStorage.getItem('iptv_history')||'[]');

    // --- Helpers ---
    function saveFavs(){ localStorage.setItem('iptv_favs', JSON.stringify(favorites)); }
    function saveHistory(){ localStorage.setItem('iptv_history', JSON.stringify(history)); updateHistoryUI(); }
    function updateHistoryUI(){ historyCount.textContent = 'History: '+history.length; lastPlayed.textContent = history.length? new Date(history[history.length-1].when).toLocaleString() : 'Last: —'; }

    function fuzzyMatch(text, query){ if(!query) return true; return text.toLowerCase().includes(query.toLowerCase()); }

    function buildCategories(){ const cats = new Set(); combinedChannels.forEach(ch => ch.category && cats.add(ch.category)); category.innerHTML = '<option value="all">All Categories</option>'; cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; category.appendChild(o); }); }

    function showSkeleton(){ channelList.innerHTML=''; for(let i=0;i<6;i++){ const s=document.createElement('div'); s.className='skeleton'; channelList.appendChild(s); } }

    function loadChannels(){ showSkeleton(); setTimeout(()=>{
      const q = search.value.trim(); const sel = category.value;
      channelList.innerHTML=''; visibleList = [];
      combinedChannels.forEach((ch, idx)=>{
        if(!fuzzyMatch(ch.name+' '+(ch.category||''), q)) return;
        if(sel!=='all' && ch.category !== sel) return;
        visibleList.push({ch,idx});
        const el=document.createElement('div'); el.className='channel';
        const logo=document.createElement('img'); logo.src=ch.logo||'logo.png'; el.appendChild(logo);
        const info=document.createElement('div'); info.className='ch-info';
        const name=document.createElement('div'); name.className='ch-name'; name.textContent=ch.name; info.appendChild(name);
        const meta=document.createElement('div'); meta.className='ch-meta'; meta.textContent=(ch.category||'') + (ch.type?(' • '+ch.type.toUpperCase()):''); info.appendChild(meta);
        el.appendChild(info);
        const fav=document.createElement('button'); fav.className='fav-btn'; fav.innerHTML = favorites.includes(idx)?'❤️':'♡'; fav.onclick = (e)=>{ e.stopPropagation(); toggleFav(idx, fav); };
        el.appendChild(fav);
        el.onclick = ()=> playIndex(idx);
        channelList.appendChild(el);
      });

      if(visibleList.length===0){ const p=document.createElement('div'); p.style.padding='12px'; p.textContent='No channels match your search.'; channelList.appendChild(p); }
    }, 250);
    }

    function toggleFav(idx, btn){ const i=favorites.indexOf(idx); if(i>=0) favorites.splice(i,1); else favorites.push(idx); btn.innerHTML = favorites.includes(idx)?'❤️':'♡'; saveFavs(); }

    function playIndex(idx){ currentIndex = idx; const ch = combinedChannels[idx]; playChannel(ch, idx); }

    async function stopAll(){ if(hls){ try{ hls.destroy(); }catch(e){} hls=null; } if(shakaPlayer){ try{ shakaPlayer.unload(); }catch(e){} shakaPlayer=null; }
      try{ video.pause(); video.removeAttribute('src'); video.load(); video.currentTime=0; }catch(e){}
      iframe.style.display='none'; iframe.src=''; video.style.display='none';
    }

    async function playChannel(ch, idx){ loading.style.display='flex'; stopAll(); nowName.textContent = ch.name; nowEpg.textContent = (ch.epg && ch.epg[0])? ch.epg[0][0] + ' • ' + ch.epg[0][1] : 'No EPG'; nowLogo.src = ch.logo||''; nowLogo.style.display = ch.logo? 'block':'none'; cardTitle.textContent = ch.name; cardEpg.textContent = nowEpg.textContent; cardLogo.src = ch.logo||''; cardLogo.style.display = ch.logo? 'block':'none'; favToggle.textContent = favorites.includes(idx)?'❤️':'♡';

      // store history
      history.push({when:Date.now(),channel:ch.name}); if(history.length>200) history.shift(); saveHistory();

      try{
        if(ch.type==='youtube' || ch.url.includes('youtube.com') || ch.url.includes('youtu.be')){
          iframe.src = ch.url + (ch.url.includes('?')? '&':'?') + 'autoplay=1'; iframe.style.display='block'; loading.style.display='none'; return;
        }

        if(ch.type==='hls' || ch.url.endsWith('.m3u8')){
          video.style.display='block';
          if(Hls.isSupported()){
            hls = new Hls({lowLatencyMode:true});
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play());
          } else if(video.canPlayType('application/vnd.apple.mpegurl')){
            video.src = ch.url; video.play();
          }
          loading.style.display='none'; return;
        }

        if(ch.type==='dash' || ch.url.endsWith('.mpd')){
          video.style.display='block';
          shaka.polyfill.installAll(); if(!shaka.Player.isBrowserSupported()){ alert('Shaka not supported'); loading.style.display='none'; return; }
          shakaPlayer = new shaka.Player(video);
          await shakaPlayer.load(ch.url); video.play(); loading.style.display='none'; return;
        }

        // fallback: try as direct video
        video.style.display='block'; video.src = ch.url; await video.play(); loading.style.display='none';
      }catch(e){ console.error(e); alert('Error playing stream.'); loading.style.display='none'; }
    }

    // keyboard navigation
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft') prevChannel();
      if(e.key==='ArrowRight') nextChannel();
      if(e.key==='f') toggleFav(currentIndex);
    });

    function prevChannel(){ if(currentIndex<=0) return; playIndex(currentIndex-1); }
    function nextChannel(){ if(currentIndex<0) return; if(currentIndex+1 >= combinedChannels.length) return; playIndex(currentIndex+1); }

    prevBtn.onclick = prevChannel; nextBtn.onclick = nextChannel;

    pipBtn.onclick = async ()=>{
      try{
        if(document.pictureInPictureElement){ await document.exitPictureInPicture(); return; }
        if(video.style.display!=='block') return alert('PiP only works on video streams');
        await video.requestPictureInPicture();
      }catch(e){ alert('PiP failed: '+ (e.message||e)); }
    }

    reloadBtn.onclick = ()=>{ if(currentIndex<0) return; const ch = combinedChannels[currentIndex]; playChannel(ch, currentIndex); }

    favToggle.onclick = ()=>{ if(currentIndex<0) return; const idx=currentIndex; const i=favorites.indexOf(idx); if(i>=0) favorites.splice(i,1); else favorites.push(idx); favToggle.textContent = favorites.includes(idx)?'❤️':'♡'; saveFavs(); }

    // collapse and theme persistence
    collapseBtn.onclick = ()=>{ sidebar.classList.toggle('collapsed'); localStorage.setItem('iptv_sidebar_collapsed', sidebar.classList.contains('collapsed')); }
    themeBtn.onclick = ()=>{ document.documentElement.classList.toggle('light'); localStorage.setItem('iptv_theme', document.documentElement.classList.contains('light')?'light':'dark'); }

    // apply initial preferences
    if(localStorage.getItem('iptv_sidebar_collapsed')==='true') sidebar.classList.add('collapsed');
    if(localStorage.getItem('iptv_theme')==='light') document.documentElement.classList.add('light');

    // UI updates
    function updateUI(){ buildCategories(); loadChannels(); updateHistoryUI(); }

    // initial
    document.addEventListener('DOMContentLoaded', ()=>{
      updateUI();
      // resume last
      const lastIdx = parseInt(localStorage.getItem('iptv_last_index')||'-1',10);
      if(!isNaN(lastIdx) && lastIdx>=0 && lastIdx<combinedChannels.length){ playIndex(lastIdx); }
    });

    // remember last played
    window.addEventListener('beforeunload', ()=>{ if(currentIndex>=0) localStorage.setItem('iptv_last_index', currentIndex); });

    // search handlers
    search.addEventListener('input', ()=> loadChannels());
    category.addEventListener('change', ()=> loadChannels());

    // expose for debug
    window.playIndex = playIndex;
    window.combinedChannels = combinedChannels;

  </script>
</body>
  </html>
  
